---

title: 【ADAS】Camera in the Loop

date: 2018.5.9

categories: 自动驾驶仿真测试

tags: 

 - CATARC

description:  摄像头在环测试的分类以及“黑箱”的理解

---
# Camera In the Loop
下面根据四个方面的信息来搜集相关资料。

## PanoSim 像机模型

参考：
[基于PanoSim的ADAS摄像头在环测试系统解决方案](https://wenku.baidu.com/view/7764eba705a1b0717fd5360cba1aa81144318fb3###)

PanoSim 提供了高仿真度的像机模型，通过车载视觉传感建模虚拟化真实像机，包括鱼眼像机、针孔像机、双目像机。像机模型图像能够添加暗角、模糊、畸变等物理特性效果，逼真还原真实图像效果。并能够通过像机在环，对标真实相机参数，定制开发图像识别功能。


PanoSim 依据现阶段各种机构、主机厂的像机要求，根据真实摄像头接入以及控制器接入，提供两种摄像头硬件在环仿真测试方案:
1. 摄像头暗箱在环:基于显示屏画面拍摄方案，直接接入真实摄像头系统;
2. 摄像头控制器在环:将场景环境数据直接注入ADAS控制器，单独对控制器进行测试。



### 摄像头暗箱在环 

采用由摄像头作为图像信号采集处理单元进行硬件在环仿真，在暗箱中，由工控机生成。**暗箱中显示器虚拟场景画面**，摄像头拍摄虚拟场景画面，实时采集传感数据，输出至传感数据处理单元供图像处理器进行数据处理，并将处理结果传输给传感融合ECU，最后通过控制算法对进行车辆闭环控制。

摄像头暗箱在环实现流程如下图所示:

![IMAGE](/images/ADAS_CameraInLoop/418FF1FE64FD0B7A05142C1DC72D698B.jpg)



采用**真实摄像头在环**功能性能:
1. 真实摄像头数据采集传输; 
2. 为道路实测提高系统置信度; 
3. 图像传输延迟≤1ms;
4. 精确的图像数据;
5. 支持各种摄像头在环



### 摄像头控制器在环

采用PanoSim作为汽车智能驾驶实时仿真平台，由工控机生成虚拟场景，根据摄像头控制器的数据接口匹配接口，将场景信息以图像数据流的方式实时注入控制器中，**把图像数据流转换为传感数据**，输出至传感数据处理单元供图像处理器进行数据处理，并将处理结果传输给传感融合ECU，通过用户开发的控制算法识别图像，对车辆进行算法控制。

![IMAGE](/images/ADAS_CameraInLoop/6D05EC8A05FE2282E4505A1C01528DBA.jpg)

采用**摄像头板卡数据接口**功能性能:
1. 直接生成图像数据传输给ECU，无需真实摄像头;
2. 可以通过摄像头板卡生成多个摄像头信号;
3. 图像传输延迟≤1ms;
4. 精确的图像数据;
5. 支持各种摄像头镜头。

## 基于PreScan的摄像头在环

参考文献：

张可科. 基于摄像头在环的AEB行人仿真研究[A]. 中国汽车工程学会.第19届亚太汽车工程年会暨2017中国汽车工程学会年会论文集[C].中国汽车工程学会:,2017:5.


[基于摄像头在环的AEB行人仿真研究](https://www.auto-made.com/news/show-7716.html)
### 内容介绍

首先搭建了摄像头在环的仿真台架，并对摄像头进行了对标，然后介绍了车辆制动模型的建立和验证，最后针对 2018 版 CNCAP 规程中 AEB 行人测试场景进行仿真建模，并和实车测试和理论分析结果进行对比，对比结果趋于一致，充分验证了 HIL 仿真测试的可信度｡ 

### 现有的摄像头硬件在环方案

现有的摄像头硬件在环方案主要有两种:信号注入和投影方式｡

1. 信号注入方式包括图像注入和目标注入等方式，两种注入都需要供应商开放相应的注入硬件接口和信号描述，而且成本很高。
2. 投影方式的优点是不用开放摄像头内部硬件接口，具有通用性和成本低的优势。


### 摄像头标定过程
![IMAGE](/images/ADAS_CameraInLoop/C9F23D2280D8660ADEAD78E3B447F4E9.jpg)

其中车辆动力学模型运行于dSPACE实时系统中;基于PreScan软件的虚拟视景运行于计算机中;实时系统计算得到的车辆状态与目标状态等信息传输到计算机中，PreScan对虚拟视景中的物体进行更新并显示到显示器上;同时摄像头传感器通过拍摄屏幕的画面，模拟摄像头在真实世界工作的情形。



步骤:
(1) 虚拟摄像头参数设置。
显示器的图像由PreScan中的虚拟摄像头传感器输出得到,因此需要将虚拟传感器的安装位置和FOV（Field of View，视野）角度设置为与摄像头硬件一致。

(2) 摄像头硬件物理位置的确定。首先将摄像头的镜头垂直对准显示屏的中心，进一步调整硬件摄像头与屏幕的垂直距离，使得硬件摄像头拍摄到的图像正好覆盖显示器的内部边框，以保证屏幕图像的比例与真实情况一致，如图2所示。


摄像头标定结果如图3所示，显示了在本车与行人目标物接近过程中，摄像头输出的本车与行人之间相对距离、相对速度和碰撞TTC值与仿真软件输出的真实值的对比。从对比结果可以看出，标定后摄像头输出的结果具有较高准确性。

（TTC 相对距离除以相对速度,即可得到本车与前方车辆或障碍物之碰撞时间 Time-to-Collision ）

![IMAGE](/images/ADAS_CameraInLoop/E640F3639502F2726E9155FF5408710E.jpg)


## dSPACE 公司的 HIL 仿真

来源：[释放试验用于基于摄像头和基于雷达的应用（使用闭环HIL系统）](https://www.dspace.com/zh/zho/home/applicationfields/our_solutions_for/driver_assistance_systems/hil_simulation/hil_testing_camera_and_radar.cfm)

![IMAGE](/images/ADAS_CameraInLoop/E58208AE70F6AEB87FC2DDD844366F81.jpg)

其中：
* 智能自适应巡航控制（ACC）和自动紧急制动（AEB）系统的典型的HIL装置
* MotionDesk通过3D可视化激励在环的摄相机
* dSPACE Automotive Simulation Models（ASM）用于车辆和交通仿真,雷达传感器模型用于将检测对象注入雷达ECU
* ModelDesk用于实现虚拟驾驶的参数化
* 实时HIL系统保证雷达和摄像头传感器的检测对象之间具有时间相关性

>释放测试的一个典型方法是使用摄像头盒。**摄像头传感器封闭在一个盒子中**，并通过带有3D场景的监视器进行激励。这些图片基于车辆和环境模型的数据，在带有显卡的PC上生成。这就需要较高的帧速率和足够的细节精度，并且要求实时完成，因此摄像头控制单元能够正确地识别对象，并对其分类。

### 单盒 “One-Box”

![IMAGE](/images/ADAS_CameraInLoop/9471C760C47C8D225BFDFF84C88F593B.jpg)

### 产品视频
MAN 与 dSPACE 联手开发出了一套可以对相机和雷达系统生成的组合警报自动进行验证的解决方案。

[视频链接](https://www.dspace.com/zh/zho/home/medien/videos/productvideos/adas_video_man.cfm)

为验证自动紧急制动系统，MAN 采用了相机在环配置以及创新性雷达相机数据融合技术。

视频截图：
![IMAGE](/images/ADAS_CameraInLoop/D454EFC825E5570B1AA23429FB651BF0.jpg)
![IMAGE](/images/ADAS_CameraInLoop/A0F0F8AF0C819D9A2E108ABEC69937B9.jpg)
![IMAGE](/images/ADAS_CameraInLoop/617FBB2622D0CD76E9AE23A7B7406D0F.jpg)


## 用于多传感器感知的实时硬件在环实验室测试

参考[Real-Time Hardware-in-the-Loop Laboratory Testing for Multisensor Sense and Avoid Systems](https://www.hindawi.com/journals/ijae/2013/748751/)

这篇文章讲述的硬件在环系统的总体架构如下图所示：

![IMAGE](/images/ADAS_CameraInLoop/763DF06BBC2FF8E4BA2997333928A0E1.jpg)

其中光电传感器（EO）部分，相机被固定在光学工作台上，并处理投射在设置在其前方的LCD显示器上的图像。在摄像机和显示器之间安装了合适的准直透镜，以确保更好的均匀性条件。这些组件被封装在一个黑色的盒子里，这样可以忽略杂散光的影响。

下图显示了光学平台上的摄像机，监视器和准直器。

![IMAGE](/images/ADAS_CameraInLoop/5EE0C819D1F928301C49E34B186369B3.jpg)

下图显示了包含所有上述组件的黑盒。场景显示器计算机运行与预定义的飞行场景相关的合成视频。

![IMAGE](/images/ADAS_CameraInLoop/9C489F21B940A0A369E1A2B921C947CB.jpg)



# 个人总结

## 对于摄像头在环共分为两个方向

1. 根据不同的介绍，“摄像头黑箱在环”、“视频采集箱在环”、“摄像头盒测试”、“投影方式的摄像头硬件在环”应该指的是同一种方法，即用摄像头通过透镜，对准显示器来采集图像。缺点是：显示器的对比度有限、光学透镜引起失真、渐晕和色差。优点是：接近实际。
2. 另一种是接将原始图像数据导入摄像头的图像处理单元。“摄像头控制器在环”、“场景环境数据直接注入ADAS控制器”、“信号注入方式的摄像头硬件在环”、“摄像头板卡进行数据接口”都指的是这种方法。优点是：可以不需要真实的摄像头，支持对多个摄像头信号的处理，而且与摄像头镜头的种类无关，因为只需要数据。

## 关于 “Black Box”

我一直以为是“黑盒测试”的“黑盒”，但是看了最后那篇论文才知道，“黑箱”指的是把所有相关的仪器放在一个“黑箱子”里进行测试，这样有效地避免了外界光源对实验的干扰。所以之前的网页里提到的“暗箱”、“黑箱”、“视频采集箱”、“单盒（One-Box）”都是指上述第一种摄像头在环。